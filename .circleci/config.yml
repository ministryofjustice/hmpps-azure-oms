version: 2

workflows:
  version: 2
  oncommit:
    jobs:
      - build
  report:
    triggers:
      - schedule:
          # 9-5 monday-friday
          cron: "0 9-17 * * 1-5"
          filters:
            branches:
              only: master
    jobs:
      - report

jobs:
  build:
    docker:
      - image: circleci/node:8
    steps:
      - run: "true"
  report:
    docker:
      - image: circleci/node:8
    steps:
      - run:
          name: install azure cli and dependencies
          command: |
            echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ wheezy main" | \
              sudo tee /etc/apt/sources.list.d/azure-cli.list
            sudo apt-key adv --keyserver packages.microsoft.com --recv-keys 417A0893
            sudo curl -L https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
            sudo apt-get install apt-transport-https
            sudo apt-get update
            sudo apt-get install azure-cli

      - run:
          name: authenticate with az cli
          command: |
            az login --service-principal \
              -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET \
              --tenant 747381f4-e81f-4a43-bf68-ced6a1e14edf
      - checkout
      - run:
          name: setup app dependencies
          command: |
            npm install
            mkdir -p junit
      - run:
          name: run computer connection report for devtest
          command: |
            node main.js -e devtest computers \
              --ignore MGMLX0050,MGMLX0051,MGMLX1050 \
              --junit junit/devtest.xml
          when: always
      - run:
          name: run computer connection report for production
          command: |
            node main.js -e production computers \
              --ignore DRMLX0050,DRMLX0051,DRMLX0052,PDMLX0050,PDMLX0051,PDMLX0052,PDMLX0055 \
              --junit junit/production.xml
          when: always
      - store_test_results:
          path: junit
